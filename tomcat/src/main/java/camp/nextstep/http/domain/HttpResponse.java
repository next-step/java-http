package camp.nextstep.http.domain;

import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.OutputStream;

public class HttpResponse {
    private static final String PATH_PREFIX = "static";

    private final OutputStream outputStream;
    private final HttpHeaders headers;

    public HttpResponse(final OutputStream outputStream) {
        this.outputStream = new BufferedOutputStream(outputStream);
        this.headers = new HttpHeaders();
    }

    public void addHeader(final String name, final String value) {
        headers.add(name, value);
    }

    public void forward(final Route route) throws IOException {
        forward(route.getPath());
    }

    public void forward(final String path) throws IOException {
        final Resource resource = getResource(path);
        final byte[] resourceBytes = resource.readAllBytes();
        final String responseBody = new String(resourceBytes);
        headers.setContentLength(resourceBytes.length);
        final var response = String.join(System.lineSeparator(),
                StatusLine.createOk().convertToString(),
                headers.convertToString(),
                "",
                responseBody);

        outputStream.write(response.getBytes());
        outputStream.flush();
    }

    public void forwardBody(final String responseBody) throws IOException {
        headers.setContentType(ContentType.HTML);
        headers.setContentLength(responseBody.getBytes().length);
        final var response = String.join(System.lineSeparator(),
                StatusLine.createOk().convertToString(),
                headers.convertToString(),
                "",
                responseBody);

        outputStream.write(response.getBytes());
        outputStream.flush();
    }

    public void sendRedirect(final Route route) throws IOException {
        sendRedirect(route.getPath());
    }

    public void sendRedirect(final String location) throws IOException {
        headers.setLocation(location);
        final var response = String.join(System.lineSeparator(),
                StatusLine.createFound().convertToString(),
                headers.convertToString(),
                "",
                "");

        outputStream.write(response.getBytes());
        outputStream.flush();
    }

    private Resource getResource(final String path) {
        final Resource resource = new Resource(PATH_PREFIX + path);
        if (resource.exists()) {
            return resource;
        }
        return new Resource(PATH_PREFIX + Route.NOT_FOUND.getPath());
    }

    public void setContentType(final ContentType contentType) {
        headers.setContentType(contentType);
    }

    public void setSession(final String string) {
        headers.addSessionCookie(string);
    }
}
